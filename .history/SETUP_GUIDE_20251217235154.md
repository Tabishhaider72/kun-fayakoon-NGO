# Firebase Gallery Setup - Complete Guide

## What's Been Implemented

âœ… Server-side upload API (bypasses CORS completely)
âœ… Admin authentication page
âœ… Image validation (type, size, dimensions)
âœ… Upload progress tracking
âœ… Optimistic delete
âœ… Firestore integration
âœ… Error handling and recovery

## File Structure

```
app/
â”œâ”€â”€ admin/gallery/page.tsx          â† Admin upload interface
â”œâ”€â”€ api/upload-gallery/route.ts     â† Server-side upload handler
â””â”€â”€ gallery/page.tsx                â† Public gallery view

components/
â”œâ”€â”€ GalleryDynamic.tsx              â† Gallery display component
â””â”€â”€ Navbar.tsx                      â† Navigation (with gallery link)

lib/
â”œâ”€â”€ firebase.ts                     â† Firebase initialization
â”œâ”€â”€ gallery.ts                      â† Client-side gallery logic
â”œâ”€â”€ gallery-actions.ts              â† Server actions (auth protected)
â”œâ”€â”€ storage-server.ts               â† Server-side storage helpers
```

## Step 1: Verify Environment Variables

**Create `.env.local` in project root:**

```env
# Firebase (REQUIRED - use values from Firebase Console)
NEXT_PUBLIC_FIREBASE_API_KEY=YOUR_API_KEY
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=YOUR_AUTH_DOMAIN
NEXT_PUBLIC_FIREBASE_PROJECT_ID=YOUR_PROJECT_ID
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=YOUR_STORAGE_BUCKET
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=YOUR_SENDER_ID
NEXT_PUBLIC_FIREBASE_APP_ID=YOUR_APP_ID

# Admin Settings
NEXT_PUBLIC_ADMIN_PASSWORD=admin123
ADMIN_SECRET_KEY=your_secret_key
```

Get these from Firebase Console:
1. Go to `console.firebase.google.com`
2. Select "kun-fayakoon" project
3. Click Settings âš™ï¸ â†’ Project Settings
4. Copy values from "Web API Key" section

## Step 2: Restart Development Server

```powershell
pnpm dev
```

## Step 3: Test the Upload Flow

### Access Admin Panel
```
http://localhost:3000/admin/gallery
```

### Login
- Default password: `admin123`
- Or use your custom password

### Upload Test Image
1. Enter title: "Test Image"
2. Enter subtitle: "This is a test"
3. Select any image (JPEG, PNG, WebP, GIF)
4. File size must be < 500 KB
5. Image dimensions: 400-4000px width, 300-4000px height

### Expected Result
- See progress bar (0-100%)
- Green success message
- Image appears in `/gallery` page

## Step 4: Verify Data in Firebase

### Check Firestore
1. Go to `console.firebase.google.com`
2. Select "kun-fayakoon" project
3. Click "Firestore Database"
4. Look for "gallery" collection
5. Should see documents with:
   - `title` (string)
   - `subtitle` (string)
   - `imageUrl` (URL string)
   - `storagePath` (storage path)
   - `createdAt` (timestamp)

### Check Storage
1. Go to `console.firebase.google.com`
2. Select "kun-fayakoon" project
3. Click "Storage"
4. Look for `/gallery/{timestamp}_{filename}` files

## Step 5: Troubleshoot CORS

The implementation uses server-side uploads to **avoid CORS issues entirely**.

If you see CORS errors in browser console:

### Solution 1: Clear Browser Cache
```
Ctrl+Shift+Delete â†’ Select "All time" â†’ Clear data
```

### Solution 2: Hard Refresh
```
Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)
```

### Solution 3: Check API Route Works
1. Open DevTools (F12)
2. Go to Network tab
3. Upload an image
4. Look for `/api/upload-gallery` request
5. Check Response for errors

### Solution 4: Verify Firebase Credentials
- Check `.env.local` matches Firebase Console
- Verify Storage bucket is enabled
- Check Firestore is created

## How the Upload Works (No CORS)

```
1. User selects image in admin panel
   â†“
2. Client sends FormData to /api/upload-gallery
   â†“
3. Server receives file (no CORS here!)
   â†“
4. Server uploads to Firebase Storage
   â†“
5. Server saves metadata to Firestore
   â†“
6. Server returns success response
   â†“
7. Client updates UI
```

**Key: CORS only applies to browser-to-server requests. Server-to-Firebase has no CORS restrictions.**

## Features Walkthrough

### Admin Upload Page
- URL: `/admin/gallery`
- Password protected
- Real-time progress bar
- File validation before upload
- Success/error feedback

### Public Gallery
- URL: `/gallery`
- Displays all uploaded images
- Ordered by newest first
- Delete button for admins

### Navigation
- Gallery link added to navbar
- Links from all pages back to gallery

## Security Notes

### Current Implementation
- âš ï¸ Simple password authentication (dev only)
- âœ… Server-side validation
- âœ… File type/size checks
- âœ… Firestore rules (read public, write admin only)

### For Production
Replace simple password with:
- Firebase Authentication
- JWT tokens
- Custom claims (admin role)
- Session management

### Firestore Security Rules
Set in Firebase Console â†’ Firestore â†’ Rules:
```javascript
allow read: if true;
allow write: if request.auth != null && request.auth.token.admin == true;
```

## Common Tasks

### Change Admin Password
Edit `.env.local`:
```env
NEXT_PUBLIC_ADMIN_PASSWORD=your_new_password
```

### Delete Image from Gallery
- Go to `/gallery`
- Click Delete button on image
- Removes from Storage & Firestore

### View Upload Logs
1. Open DevTools â†’ Console
2. Check for upload progress messages
3. Check DevTools â†’ Network â†’ `/api/upload-gallery`

### Adjust File Size Limit
Edit `app/api/upload-gallery/route.ts`:
```typescript
const maxSize = 1000 * 1024; // Change to 1 MB
```

## Deployment Checklist

- [ ] `.env.local` added to production environment variables
- [ ] Firebase project is active and billing enabled
- [ ] Storage bucket exists and has files
- [ ] Firestore database created
- [ ] Security rules are set correctly
- [ ] Admin password is secure
- [ ] Test upload works after deployment

## Still Getting CORS Errors?

The new API route implementation **completely eliminates CORS errors** by processing uploads server-side.

If you still see CORS errors:
1. Check `/app/api/upload-gallery/route.ts` exists
2. Verify `.env.local` has all Firebase credentials
3. Hard refresh browser (Ctrl+Shift+R)
4. Check DevTools â†’ Network â†’ `/api/upload-gallery` request
5. Look for error in Response tab

## Next Steps

1. âœ… Run `pnpm dev`
2. âœ… Go to `/admin/gallery`
3. âœ… Upload a test image
4. âœ… Check `/gallery` to see it
5. âœ… Test delete functionality

You're all set! ğŸ‰
